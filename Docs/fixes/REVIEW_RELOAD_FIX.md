# –†–ï–®–ï–ù–ò–ï: –û—Ç–∑—ã–≤—ã –∏—Å—á–µ–∑–∞—é—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ

**–î–∞—Ç–∞:** 2026-01-07  
**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç–∑—ã–≤ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏, –Ω–æ –∏—Å—á–µ–∑–∞–µ—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞

**Race condition —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π:**

1. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
2. `AuthRepository.restoreSession()` –Ω–∞—á–∏–Ω–∞–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ –∏–∑ DataStore
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
4. `loadReviews()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è, –Ω–æ `isAuthenticated = false` (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ)
5. `refreshUserOwnReviews()` –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è (–ø—Ä–æ–≤–µ—Ä–∫–∞: `if (!isAuthenticated)`)
6. –†–µ–∑—É–ª—å—Ç–∞—Ç: –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—ã–µ –æ—Ç–∑—ã–≤—ã, –æ—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏—Å—á–µ–∑–∞—é—Ç

## –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:

```kotlin
// –í AttractionBottomSheet.kt –∏ AttractionDetailScreen.kt

LaunchedEffect(isAuthenticated) {
    if (isAuthenticated) {
        Timber.d("User authenticated, reloading reviews")
        reviewViewModel.loadReviews(attractionId, forceRefresh = true)
    }
}
```

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü—Ä–∏ —Ö–æ–ª–æ–¥–Ω–æ–º —Å—Ç–∞—Ä—Ç–µ (–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞):

```
1. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
   ‚Üì
2. AuthRepository.init() ‚Üí restoreSession() (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
   isAuthenticated = false (Unknown)
   ‚Üì
3. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   ‚Üì
4. LaunchedEffect(attractionId) ‚Üí loadReviews()
   –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—É–±–ª–∏—á–Ω—ã–µ –æ—Ç–∑—ã–≤—ã (isAuthenticated = false)
   ‚Üì
5. restoreSession() –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è ‚Üí refreshToken() ‚Üí handleAuthSuccess()
   isAuthenticated = true
   ‚Üì
6. LaunchedEffect(isAuthenticated) —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç!
   ‚Üí loadReviews(forceRefresh = true)
   ‚Üì
7. –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –æ—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   ‚Üì
8. UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–µ–∫—Ü–∏—é "–í–∞—à –æ—Ç–∑—ã–≤" ‚úÖ
```

### –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–æ–≤–æ–≥–æ –æ—Ç–∑—ã–≤–∞:

```
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–∑—ã–≤
   ‚Üì
2. submitReview() ‚Üí API —Å–æ–∑–¥–∞–µ—Ç –æ—Ç–∑—ã–≤ (status='pending')
   ‚Üì
3. –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–æ–±–∞–≤–ª—è–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à:
   _userOwnReviews.value = listOf(newReview) + _userOwnReviews.value
   ‚Üì
4. ViewModel –∫–æ–ø–∏—Ä—É–µ—Ç –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:
   _userOwnReviews.value = reviewRepository.userOwnReviews.value
   ‚Üì
5. UI —Å—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–∑—ã–≤ —Å –±–µ–π–¥–∂–µ–º "–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏" ‚úÖ
   ‚Üì
6. –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ:
   LaunchedEffect(isAuthenticated) ‚Üí loadReviews() ‚Üí refreshUserOwnReviews()
   ‚Üí –û—Ç–∑—ã–≤ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ Supabase ‚úÖ
```

## –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **AttractionBottomSheet.kt** - –¥–æ–±–∞–≤–ª–µ–Ω `LaunchedEffect(isAuthenticated)`
2. **AttractionDetailScreen.kt** - –¥–æ–±–∞–≤–ª–µ–Ω `LaunchedEffect(isAuthenticated)`
3. **ReviewRepository.kt** - —É–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
4. **ReviewViewModel.kt** - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω `submitReview()` (—É–∂–µ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ —Ä–∞–Ω–µ–µ)

## –ü—Ä–æ–≤–µ—Ä–∫–∞

### –¢–µ—Å—Ç –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏:

1. ‚úÖ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ ‚Üí –æ—Ç–∑—ã–≤ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ "–í–∞—à –æ—Ç–∑—ã–≤"
2. ‚úÖ –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (—É–±–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å)
3. ‚úÖ –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–Ω–æ–≤–∞
4. ‚úÖ –û—Ç–∫—Ä—ã—Ç—å —Ç—É –∂–µ –¥–æ—Å—Ç–æ–ø—Ä–∏–º–µ—á–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
5. ‚úÖ **–ü–†–û–í–ï–†–ö–ê:** –û—Ç–∑—ã–≤ –≤—Å–µ –µ—â–µ –≤ —Å–µ–∫—Ü–∏–∏ "–í–∞—à –æ—Ç–∑—ã–≤" —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Å—Ç–∞—Ç—É—Å–æ–º

### –õ–æ–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```
# –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
D/AuthRepository: Found stored session, attempting to refresh token
D/AuthRepository: Auth success for user: user@example.com
D/AttractionBottomSheet: User authenticated, reloading reviews for <attraction-id>
D/ReviewRepository: refreshUserOwnReviews: attractionId=<id>, userId=<user-id>
D/ReviewRepository: refreshUserOwnReviews: response code=200, isSuccessful=true
D/ReviewRepository: refreshUserOwnReviews: loaded 1 reviews, statuses=[pending]
D/ReviewViewModel: Loaded user own reviews, count=1, statuses=[pending]
```

## –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–µ—à–µ–Ω–∏—è

1. ‚úÖ **–ù–µ –ª–æ–º–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥** - –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
2. ‚úÖ **–†–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö
3. ‚úÖ **–£—Å—Ç–æ–π—á–∏–≤–æ –∫ race conditions** - –Ω–µ –≤–∞–∂–Ω–æ –∫–æ–≥–¥–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
4. ‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ª–µ–≥–∫–æ –æ—Ç–ª–∞–∂–∏–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã
5. ‚úÖ **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** - –≤—Å–µ–≥–æ 2 —Ñ–∞–π–ª–∞ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–ù–ï –≤—ã–±—Ä–∞–Ω—ã)

### ‚ùå –í–∞—Ä–∏–∞–Ω—Ç 1: –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ UI –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è auth
```kotlin
// –ù–ï –•–û–†–û–®–û: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±—É–¥–µ—Ç –∂–¥–∞—Ç—å
if (authState is AuthState.Loading) {
    CircularProgressIndicator()
} else {
    // –ø–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
}
```
**–ú–∏–Ω—É—Å:** –ü–ª–æ—Ö–æ–π UX, –∑–∞–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏

### ‚ùå –í–∞—Ä–∏–∞–Ω—Ç 2: Polling
```kotlin
// –ù–ï –•–û–†–û–®–û: –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ
LaunchedEffect(Unit) {
    while (true) {
        delay(1000)
        if (isAuthenticated) {
            loadReviews()
            break
        }
    }
}
```
**–ú–∏–Ω—É—Å:** –¢—Ä–∞—Ç–∏—Ç —Ä–µ—Å—É—Ä—Å—ã, —Å–ª–æ–∂–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å

### ‚úÖ –í—ã–±—Ä–∞–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ: Reactive LaunchedEffect
```kotlin
LaunchedEffect(isAuthenticated) {
    if (isAuthenticated) {
        loadReviews(forceRefresh = true)
    }
}
```
**–ü–ª—é—Å:** –≠–ª–µ–≥–∞–Ω—Ç–Ω–æ, —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø–∞–º Compose

## –ò—Ç–æ–≥

**–ü—Ä–æ–±–ª–µ–º–∞:** Race condition –º–µ–∂–¥—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–µ—Å—Å–∏–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–æ–π –æ—Ç–∑—ã–≤–æ–≤  
**–†–µ—à–µ–Ω–∏–µ:** –†–µ–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ `LaunchedEffect(isAuthenticated)`  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –û—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∏ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏! üéâ
