# üéØ Offline-First Data Layer: –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

**–î–∞—Ç–∞:** 6 —è–Ω–≤–∞—Ä—è 2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã](#–æ–±–∑–æ—Ä-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)
2. [Offline-First –ø–æ–¥—Ö–æ–¥](#offline-first-–ø–æ–¥—Ö–æ–¥)
3. [–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π](#–∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π)
4. [–°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤](#—Å—Ç—Ä–∞—Ç–µ–≥–∏—è-–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è-–º–∞—Ä–∫–µ—Ä–æ–≤)
5. [–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è](#–ø—Ä–æ–≤–µ–¥–µ–Ω–Ω–∞—è-–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
6. [–í—ã–≤–æ–¥—ã](#–≤—ã–≤–æ–¥—ã)

---

## üèóÔ∏è –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     DATA LAYER ARCHITECTURE                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                  ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ   ‚îÇ   Supabase   ‚îÇ      ‚îÇ  Room DB     ‚îÇ      ‚îÇ  Image Cache ‚îÇ ‚îÇ
‚îÇ   ‚îÇ  (Server)    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  (Local)    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   (Coil)    ‚îÇ ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ         ‚îÇ                      ‚îÇ                      ‚îÇ          ‚îÇ
‚îÇ         ‚îÇ                      ‚îÇ                      ‚îÇ          ‚îÇ
‚îÇ   [Source of Truth       [Source of Truth      [Disk + Memory]  ‚îÇ
‚îÇ    for Server]           for App - OFFLINE]                      ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ   ‚îÇ              SyncService (Delta Sync)                     ‚îÇ ‚îÇ
‚îÇ   ‚îÇ  ‚Ä¢ Tracks last sync timestamp                            ‚îÇ ‚îÇ
‚îÇ   ‚îÇ  ‚Ä¢ Fetches only changes since last sync                  ‚îÇ ‚îÇ
‚îÇ   ‚îÇ  ‚Ä¢ Preserves local favorites                             ‚îÇ ‚îÇ
‚îÇ   ‚îÇ  ‚Ä¢ Handles tombstones (deleted records)                  ‚îÇ ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **AttractionRepositoryImpl** - —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å offline-first –ª–æ–≥–∏–∫–æ–π
2. **SyncService** - —Å–µ—Ä–≤–∏—Å delta-—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Supabase
3. **DataSyncManager** - –º–µ–Ω–µ–¥–∂–µ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
4. **ImageCacheManager** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (Coil)
5. **MapPreloadManager** - –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–∞—Ä–∫–µ—Ä–æ–≤
6. **VisualMarkerProvider** - –ø—Ä–æ–≤–∞–π–¥–µ—Ä –≤–∏–∑—É–∞–ª—å–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤

---

## ‚úÖ Offline-First –ø–æ–¥—Ö–æ–¥

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ MapPreloadManager

```kotlin
/**
 * OFFLINE-FIRST FLOW:
 * 1. Read cached data from Room immediately (fast, works offline)
 * 2. Create markers and show UI
 * 3. Trigger background Supabase sync (non-blocking)
 * 4. Update markers if sync brings new data
 */
```

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã

#### ‚úÖ 1. –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∫—ç—à–∞

**–ö–æ–¥:** `MapPreloadManager.startPreload()`

```kotlin
// STEP 1: Load cached data from Room (INSTANT, works offline)
val cachedAttractions = withContext(Dispatchers.IO) {
    repository.getAllAttractions().first()
}

// If we have cached data, proceed immediately
if (cachedAttractions.isNotEmpty()) {
    _attractions.value = cachedAttractions
    _preloadState.value = _preloadState.value.copy(
        dataLoaded = true,
        progress = 0.3f
    )
    
    // Create markers with cached data
    createMarkersForAttractions(mapView, cachedAttractions)
    
    // Mark as ready - user can proceed
    _preloadState.value = _preloadState.value.copy(
        allMarkersReady = true,
        isLoading = false,
        progress = 1.0f
    )
    
    // Background sync (non-blocking)
    launchBackgroundSync(mapView)
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –∏–∑ Room, UI –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è —Å—Ä–∞–∑—É

#### ‚úÖ 2. –§–æ–Ω–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Supabase

**–ö–æ–¥:** `MapPreloadManager.launchBackgroundSync()`

```kotlin
private fun launchBackgroundSync(mapView: MapView) {
    scope.launch {
        try {
            val syncResult = withContext(Dispatchers.IO) {
                syncService.performSync()  // Delta sync
            }
            
            if (syncResult.success && hasChanges) {
                // Reload fresh data
                val freshAttractions = repository.getAllAttractions().first()
                
                // OPTIMIZED: Incremental update
                visualMarkerProvider?.updateVisualMarkers(freshAttractions)
            }
        } catch (e: Exception) {
            // Silent fail - user continues with cached data
        }
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ

#### ‚úÖ 3. Delta Sync –≤ SyncService

**–ö–æ–¥:** `SyncService.performSync()`

```kotlin
// 1. Get last sync timestamp
val lastSyncTimestamp = preferencesManager.getLastSyncTimestamp()
val syncSince = lastSyncTimestamp ?: DEFAULT_SYNC_TIMESTAMP

// 2. Fetch only updated attractions since last sync
val updatedResult = if (isFirstSync) {
    remoteDataSource.getAllAttractions()
} else {
    remoteDataSource.getUpdatedAttractions(syncSince)  // Delta!
}

// 3. Fetch deleted attractions (tombstones)
val deletedResult = remoteDataSource.getDeletedAttractions(syncSince)

// 4. Apply changes incrementally
updatedAttractions.forEach { dto ->
    val existingEntity = attractionDao.getAttractionById(dto.id)
    if (existingEntity != null) {
        // Preserve favorite status
        attractionDao.updateAttraction(
            dto.toEntity().copy(isFavorite = existingEntity.isFavorite)
        )
    } else {
        attractionDao.insertAttraction(dto.toEntity())
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è favorites

---

## üñºÔ∏è –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### ImageCacheManager (Coil)

#### ‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫—ç—à–∞

```kotlin
companion object {
    private const val MEMORY_CACHE_MAX_SIZE_PERCENT = 0.25  // 25% –ø–∞–º—è—Ç–∏
    private const val DISK_CACHE_MAX_SIZE_MB = 250L         // 250MB –¥–∏—Å–∫
}

val imageLoader: ImageLoader by lazy {
    ImageLoader.Builder(context)
        .memoryCache {
            MemoryCache.Builder(context)
                .maxSizePercent(MEMORY_CACHE_MAX_SIZE_PERCENT)
                .build()
        }
        .diskCache {
            CoilDiskCache.Builder()
                .directory(getCacheDirectory())
                .maxSizeBytes(DISK_CACHE_MAX_SIZE_MB * 1024 * 1024)
                .build()
        }
        .respectCacheHeaders(false)  // Ignore server cache headers
        .crossfade(true)
        .build()
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à (Memory + Disk), –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã

#### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

```kotlin
suspend fun isImageCached(url: String): Boolean = withContext(Dispatchers.IO) {
    // Check memory cache
    val memoryCacheKey = MemoryCache.Key(url)
    if (memoryCache?.get(memoryCacheKey) != null) {
        return@withContext true
    }
    
    // Check disk cache
    val snapshot = diskCache?.openSnapshot(url)
    if (snapshot != null) {
        snapshot.close()
        return@withContext true
    }
    
    false
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π, –∏–∑–±–µ–≥–∞–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

#### ‚úÖ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

```kotlin
// –í AttractionRepositoryImpl
private suspend fun preloadFirstImages(attractions: List<AttractionDto>) {
    val firstImageUrls = attractions.mapNotNull { it.images.firstOrNull() }
    if (firstImageUrls.isNotEmpty()) {
        imageCacheManager.preloadImages(firstImageUrls)
    }
}

// –í MapPreloadManager
val imageUrls = attractions.mapNotNull { it.images.firstOrNull() }
if (imageUrls.isNotEmpty()) {
    withContext(Dispatchers.IO) {
        imageCacheManager.preloadImages(imageUrls)
    }
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –≤ —Ñ–æ–Ω–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö

---

## üó∫Ô∏è –°—Ç—Ä–∞—Ç–µ–≥–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤

### ‚ùå –ü—Ä–æ–±–ª–µ–º–∞ (–¥–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)

```kotlin
// –ü–õ–û–•–û: –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–æ–∑–¥–∞—á–∞ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
if (freshAttractions != _attractions.value) {
    _attractions.value = freshAttractions
    createMarkersForAttractions(mapView, freshAttractions)  // ‚ùå –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö!
}
```

**–ù–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:**
- –ú–µ—Ä—Ü–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
- –õ–∏—à–Ω—è—è —Ä–∞–±–æ—Ç–∞ GPU
- –ü–æ—Ç–µ—Ä—è –∞–Ω–∏–º–∞—Ü–∏–π
- –ü–ª–æ—Ö–æ–π UX

### ‚úÖ –†–µ—à–µ–Ω–∏–µ (–ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏)

```kotlin
// –•–û–†–û–®–û: –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤
if (freshAttractions != _attractions.value) {
    val previousAttractions = _attractions.value
    val previousById = previousAttractions.associateBy { it.id }

    // 1) –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≥—Ä–µ–≤–∞–µ–º –∫—ç—à –∫–∞—Ä—Ç–∏–Ω–æ–∫ –¥–ª—è NEW/UPDATED –º–µ—Å—Ç,
    //    —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∫–æ–Ω–æ–∫ –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ–ø–∞–ª–æ –≤ cache-first –ø—É—Ç—å.
    val changedOrNewImageUrls = freshAttractions
        .filter { attraction ->
            val old = previousById[attraction.id]
            old == null || old.images != attraction.images
        }
        .mapNotNull { it.images.firstOrNull() }
        .distinct()

    if (changedOrNewImageUrls.isNotEmpty()) {
        withContext(Dispatchers.IO) {
            imageCacheManager.preloadImages(changedOrNewImageUrls)
        }
    }

    // 2) –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö + —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã.
    withContext(Dispatchers.Main) {
        visualMarkerProvider?.updateVisualMarkers(freshAttractions)
    }

    // 3) –û–±–Ω–æ–≤–ª—è–µ–º in-memory state
    _attractions.value = freshAttractions
}
```

### VisualMarkerProvider.updateVisualMarkers()

```kotlin
fun updateVisualMarkers(attractions: List<Attraction>) {
    val desiredIds = attractions.map { it.id }.toSet()
    val desiredById = attractions.associateBy { it.id }
    
    // Remove markers that are no longer present
    val toRemove = markers.keys.toSet() - desiredIds
    toRemove.forEach { id ->
        markers.remove(id)?.let { placemark ->
            mapObjectCollection.remove(placemark)
        }
    }
    
    // Add only new markers
    val currentIds = markers.keys.toSet()
    attractions.forEach { attraction ->
        if (!currentIds.contains(attraction.id)) {
            addVisualMarker(attraction, animated = false)
        }
    }

    // Update existing markers when data changed:
    // - refresh geometry if coordinates changed
    // - refresh userData to keep selection visuals consistent
    // - invalidate cached icon if images/category changed
    (desiredIds intersect currentIds).forEach { id ->
        val placemark = markers[id] ?: return@forEach
        val newAttraction = desiredById[id] ?: return@forEach
        val oldAttraction = placemark.userData as? Attraction

        placemark.userData = newAttraction

        val newPoint = Point(newAttraction.location.latitude, newAttraction.location.longitude)
        if (placemark.geometry != newPoint) {
            placemark.geometry = newPoint
        }

        val shouldInvalidateIcon = oldAttraction == null ||
            oldAttraction.images != newAttraction.images ||
            oldAttraction.category != newAttraction.category
        if (shouldInvalidateIcon) {
            markerImages.remove("${id}_normal")
            markerImages.remove("${id}_selected")
            placemark.setIcon(getOrCreateImageProvider(newAttraction, isSelected = false))
        }
    }
}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ù–µ—Ç –º–µ—Ä—Ü–∞–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤
- ‚úÖ –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ
- ‚úÖ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ü–ª–∞–≤–Ω—ã–π UX

---

## üîß –ü—Ä–æ–≤–µ–¥–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ MapPreloadManager.kt

**–§–∞–π–ª:** `app/src/main/java/com/adygyes/app/presentation/ui/util/MapPreloadManager.kt`

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
```kotlin
/**
 * Launch background sync with Supabase (non-blocking)
 * Uses incremental marker updates to avoid full reload and flickering
 */
private fun launchBackgroundSync(mapView: MapView) {
    // ... sync logic ...
    
    // BEFORE:
    // createMarkersForAttractions(mapView, freshAttractions)
    
    // AFTER: Preload changed/new images first, then update markers incrementally
    val previousAttractions = _attractions.value
    val previousById = previousAttractions.associateBy { it.id }
    val changedOrNewImageUrls = freshAttractions
        .filter { attraction ->
            val old = previousById[attraction.id]
            old == null || old.images != attraction.images
        }
        .mapNotNull { it.images.firstOrNull() }
        .distinct()

    if (changedOrNewImageUrls.isNotEmpty()) {
        withContext(Dispatchers.IO) {
            imageCacheManager.preloadImages(changedOrNewImageUrls)
        }
    }

    withContext(Dispatchers.Main) {
        visualMarkerProvider?.updateVisualMarkers(freshAttractions)
    }

    _attractions.value = freshAttractions
}
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

| –ê—Å–ø–µ–∫—Ç | –î–æ | –ü–æ—Å–ª–µ |
|--------|-----|-------|
| **–ú–µ—Ä—Ü–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤** | ‚ùå –î–∞ (–ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏) | ‚úÖ –ù–µ—Ç (–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ) |
| **–°–∫–æ—Ä–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** | üêå –ú–µ–¥–ª–µ–Ω–Ω–æ (–ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö) | ‚ö° –ë—ã—Å—Ç—Ä–æ (—Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è) |
| **–ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** | üîÑ –í—Å–µ –∑–∞–Ω–æ–≤–æ | üéØ –¢–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ |
| **UX –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏** | üòï –ó–∞–º–µ—Ç–Ω—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ | üòä –ù–µ–∑–∞–º–µ—Ç–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è |

---

## üìä –í—ã–≤–æ–¥—ã

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ

1. **Offline-First –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** - –¥–∞–Ω–Ω—ã–µ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑ Room
2. **Delta Sync** - —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. **–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –∫—ç—à –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** - Memory + Disk cache
4. **–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö** - –Ω–∞ splash screen
5. **–ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** - –≤ —Ñ–æ–Ω–µ
6. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è** - favorites —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

### ‚úÖ –ß—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ

1. **–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤** - –≤–º–µ—Å—Ç–æ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ—Å–æ–∑–¥–∞—á–∏
2. **–í—ã–±–æ—Ä–æ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** - —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ

### üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

#### –¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ò–î–ï–ê–õ–¨–ù–ê –¥–ª—è:
- ‚úÖ –ë—ã—Å—Ç—Ä–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ –†–∞–±–æ—Ç—ã –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
- ‚úÖ –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ —Ç—Ä–∞—Ñ–∏–∫–∞
- ‚úÖ –ü–ª–∞–≤–Ω–æ–≥–æ UX

#### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):

1. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** (—Å WorkManager)
   ```kotlin
   // Schedule background sync every 6 hours
   PeriodicWorkRequestBuilder<SyncWorker>(6, TimeUnit.HOURS)
       .setConstraints(
           Constraints.Builder()
               .setRequiredNetworkType(NetworkType.CONNECTED)
               .build()
       )
       .build()
   ```

2. **–°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —ç–∫–æ–Ω–æ–º–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫)
   ```kotlin
   ImageRequest.Builder(context)
       .data(url)
       .size(800) // –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–∞–∑–º–µ—Ä
       .format(DecodeFormat.MEMORY_SAFE)
       .build()
   ```

3. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π –∫—ç—à** (–æ—á–∏—â–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è)
   ```kotlin
   if (cacheSize > MAX_CACHE_SIZE * 0.9) {
       clearOldestCachedImages()
   }
   ```

---

## üé¨ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–°–∏—Å—Ç–µ–º–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Kotlin –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –Ω–∞ –û–¢–õ–ò–ß–ù–û!** ‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê

- ‚úÖ Offline-First –ø–æ–¥—Ö–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–¥–µ–∞–ª—å–Ω–æ
- ‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ
- ‚úÖ –ú–∞—Ä–∫–µ—Ä—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –±–µ–∑ –º–µ—Ä—Ü–∞–Ω–∏—è
- ‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç UI
- ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ –∏ –æ—Ç–∑—ã–≤—á–∏–≤–æ

**–ü—Ä–æ–≤–µ–¥–µ–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:**
- –ó–∞–º–µ–Ω–∏–ª –ø–æ–ª–Ω—É—é –ø–µ—Ä–µ—Å–æ–∑–¥–∞—á—É –º–∞—Ä–∫–µ—Ä–æ–≤ –Ω–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
- –î–æ–±–∞–≤–∏–ª –≤—ã–±–æ—Ä–æ—á–Ω—É—é –∑–∞–≥—Ä—É–∑–∫—É —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö/–æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.** –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ! üöÄ
